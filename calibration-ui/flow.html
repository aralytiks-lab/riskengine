<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LT Risk Engine â€” Data Flow &amp; Architecture</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0F172A; color: #E2E8F0; }
    .tab-btn { padding: 10px 24px; font-size: 13px; font-weight: 600; background: none; border: none; cursor: pointer; border-bottom: 2px solid transparent; color: #94A3B8; transition: all 0.2s; }
    .tab-btn:hover { color: #CBD5E1; }
    .tab-btn.active { color: #38BDF8; border-bottom-color: #38BDF8; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideRight { from { transform: translateX(-20px); opacity:0; } to { transform: translateX(0); opacity:1; } }
    .fade-in { animation: fadeIn 0.4s ease-out forwards; }
    .stage-card { background: #1E293B; border: 1px solid #334155; border-radius: 12px; padding: 20px; transition: all 0.3s; margin-bottom: 16px; }
    .stage-card.active { border-color: #38BDF8; box-shadow: 0 0 30px rgba(56,189,248,0.15); }
    .stage-card.completed { border-color: #22C55E; }
    .data-pill { display: inline-block; padding: 3px 10px; border-radius: 6px; font-size: 11px; font-family: monospace; margin: 2px; }
    .arch-box { border: 2px solid; border-radius: 12px; padding: 16px; text-align: center; transition: all 0.3s; }
    .arch-box:hover { transform: translateY(-2px); }
    .json-panel { background: #0F172A; border: 1px solid #334155; border-radius: 8px; padding: 16px; font-family: 'SF Mono','Fira Code',monospace; font-size: 11.5px; line-height: 1.6; overflow: auto; max-height: 600px; white-space: pre-wrap; word-break: break-word; }
    .jk { color: #38BDF8; } .js { color: #A78BFA; } .jn { color: #34D399; } .jb { color: #FB923C; } .jnull { color: #64748B; }
    .mapping-row { display: grid; grid-template-columns: 1fr 40px 1fr 40px 1fr; align-items: center; padding: 8px 0; border-bottom: 1px solid #1E293B; font-size: 12px; }
    .arrow-col { text-align: center; color: #38BDF8; font-weight: 700; }
    .src-col { font-family: monospace; color: #A78BFA; }
    .kpi-col { font-family: monospace; color: #34D399; font-weight: 600; }
    .formula-col { font-family: monospace; color: #FB923C; font-size: 11px; }
    .kpi-bar { height: 6px; border-radius: 3px; transition: width 0.8s ease; }
    .note-box { background: #1E293B; border-left: 3px solid #F59E0B; padding: 10px 14px; border-radius: 0 6px 6px 0; margin-top: 12px; font-size: 11px; color: #94A3B8; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SOURCE SYSTEM (SST) â†’ KPI MAPPING
    // SST = LeaseTeq source CRM/origination platform
    // ODS/DWH is DOWNSTREAM (analytics), NOT in scoring path
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const SOURCE_MAPPING = [
      { kpi: "LTV", type: "CALCULATED", sources: ["SST (LeaseTeq)"], sourceFields: ["financed_amount", "offer_price"], formula: "(financed_amount / offer_price) Ã— 100", description: "Calculated by Risk Engine from contract & vehicle data in SST" },
      { kpi: "Term", type: "DIRECT", sources: ["SST (LeaseTeq)"], sourceFields: ["duration"], formula: "duration (months)", description: "Contract term â€” direct from SST" },
      { kpi: "Age", type: "CALCULATED", sources: ["SST (LeaseTeq)"], sourceFields: ["date_of_birth"], formula: "today âˆ’ date_of_birth", description: "Calculated by Risk Engine from person DOB in SST" },
      { kpi: "CRIF", type: "DIRECT", sources: ["CRIF Bureau API"], sourceFields: ["crif_score"], formula: "crif_score (0-1000)", description: "External bureau score â€” fetched by Flowable from CRIF API" },
      { kpi: "Intrum", type: "DIRECT", sources: ["Intrum API"], sourceFields: ["intrum_score"], formula: "intrum_score", description: "Debt collection score â€” fetched by Flowable from Intrum API" },
      { kpi: "DSCR", type: "DIRECT", sources: ["SST (LeaseTeq)"], sourceFields: ["dscr_value"], formula: "dscr_value (pre-calculated at source)", description: "Now calculated at source by SST â€” used by underwriters during origination. Engine uses it directly. (Previously calculated in DWH)" },
      { kpi: "Permit", type: "DIRECT", sources: ["SST (LeaseTeq)"], sourceFields: ["foreigner_id_card", "customer_type"], formula: "party_type + permit_type", description: "Residence permit type derived from SST person data" },
      { kpi: "VehiclePriceTier", type: "DIRECT", sources: ["SST (LeaseTeq)"], sourceFields: ["offer_price"], formula: "offer_price tier bucket", description: "Vehicle price segment from SST contract data" },
      { kpi: "ZEK", type: "DIRECT", sources: ["ZEK Bureau API"], sourceFields: ["zek_code", "zek_entry_count"], formula: "zek_code + entry count", description: "Swiss central credit bureau â€” fetched by Flowable from ZEK API" },
      { kpi: "DealerRisk", type: "CALCULATED", sources: ["SST (LeaseTeq)", "Portfolio Stats"], sourceFields: ["dealer_id", "historical default rate"], formula: "dealer_default_rate from portfolio", description: "Dealer's historical default rate â€” derived from portfolio performance" },
    ];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SAMPLE INPUT / OUTPUT JSON
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const SAMPLE_INPUT = {
      request_id: "FLOW-2026-02-26-001",
      timestamp: "2026-02-26T17:00:00Z",
      customer: {
        customer_id: "CUST-12345", date_of_birth: "1985-06-15", party_type: "B2C", permit_type: "C", nationality: "CH", income_type: "employed",
        monthly_gross_income: 9500.00, monthly_net_income: 7200.00, monthly_existing_obligations: 450.00, monthly_rent: 1400.00, monthly_insurance: 280.00, monthly_alimony: 0.00,
        crif_score: 680, intrum_score: 4, zek_has_entries: false, zek_entry_count: 0, dscr_value: 4.07
      },
      vehicle: { vehicle_price: 55000.00, vehicle_type: "SUV", vehicle_age_months: 0, is_electric: true },
      contract: { contract_id: "CTR-2026-0042", financed_amount: 44000.00, downpayment_amount: 11000.00, residual_value: 22000.00, term_months: 48, monthly_payment: 850.00, interest_rate: 4.25, product_type: "LEASING" },
      dealer: { dealer_id: "DLR-ZURICH-007", dealer_name: "AutoCenter Zurich", dealer_default_rate: 0.035, dealer_active_months: 48, dealer_volume_tier: "GOLD" }
    };

    const SAMPLE_OUTPUT = {
      request_id: "FLOW-2026-02-26-001", assessment_id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890", model_version: "1.2",
      total_score: 31.0, tier: "BRIGHT_GREEN", decision: "AUTO_APPROVE", probability_of_default: 0.015,
      factor_scores: [
        { factor_name: "LTV", raw_value: "80.0%", bin_label: "75-85%", weight: 0.15, raw_score: 4.0 },
        { factor_name: "Term", raw_value: "48m", bin_label: "37-48m", weight: 0.10, raw_score: 6.0 },
        { factor_name: "Age", raw_value: "40", bin_label: "36-45", weight: 0.10, raw_score: 0.0 },
        { factor_name: "CRIF", raw_value: "680", bin_label: "500-699 (Good)", weight: 0.15, raw_score: 4.0 },
        { factor_name: "Intrum", raw_value: "4", bin_label: ">3 (Established)", weight: 0.10, raw_score: 5.0 },
        { factor_name: "DSCR", raw_value: "4.07", bin_label: "3-7 (Adequate)", weight: 0.15, raw_score: 0.0 },
        { factor_name: "Permit", raw_value: "C_permit", bin_label: "C_permit", weight: 0.10, raw_score: 5.0 },
        { factor_name: "VehiclePriceTier", raw_value: "55000", bin_label: "50k-100k (Premium)", weight: 0.05, raw_score: 2.0 },
        { factor_name: "ZEK", raw_value: "Clean", bin_label: "No negative entries", weight: 0.05, raw_score: 5.0 },
        { factor_name: "DealerRisk", raw_value: "3.5%", bin_label: "3-8% (Average)", weight: 0.05, raw_score: 0.0 }
      ],
      dscr: { dscr_value: 4.07, monthly_disposable_income: 3585.0, monthly_payment: 850.0, calculation_method: "SOURCE_DIRECT", is_valid: true },
      business_rule_overrides: [],
      evaluated_at: "2026-02-26T17:00:00.003Z", processing_time_ms: 3, legacy_score: 421, legacy_band: "B"
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // JSON RENDERER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function JsonHighlight({ data }) {
      const json = JSON.stringify(data, null, 2);
      const lines = json.split('\n').map(line => {
        return line.replace(/"([^"]+)"(?=\s*:)/g, '<span class="jk">"$1"</span>')
          .replace(/:\s*"([^"]*)"/g, ': <span class="js">"$1"</span>')
          .replace(/:\s*(-?\d+\.?\d*)/g, ': <span class="jn">$1</span>')
          .replace(/:\s*(true|false)/g, ': <span class="jb">$1</span>')
          .replace(/:\s*(null)/g, ': <span class="jnull">$1</span>');
      });
      return <div className="json-panel" dangerouslySetInnerHTML={{ __html: lines.join('\n') }} />;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STAGE BAR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function StageBar({ stage }) {
      const stages = [
        { n: 1, l: "Source Systems", icon: "ğŸ¢" },
        { n: 2, l: "Flowable POST", icon: "âš™ï¸" },
        { n: 3, l: "KPI Derivation", icon: "ğŸ”¬" },
        { n: 4, l: "Bin + Score", icon: "ğŸ“Š" },
        { n: 5, l: "Rules + Tier", icon: "âš–ï¸" },
        { n: 6, l: "Response", icon: "ğŸ“¥" },
      ];
      return (
        <div style={{ display: "flex", alignItems: "center", gap: "0", marginBottom: "28px" }}>
          {stages.map((s, i) => {
            const completed = stage > s.n, active = stage === s.n;
            const bg = completed ? "#22C55E" : active ? "#38BDF8" : "#334155";
            const tc = completed || active ? "#fff" : "#64748B";
            return (
              <React.Fragment key={i}>
                <div style={{ display: "flex", flexDirection: "column", alignItems: "center", gap: "4px", minWidth: "70px" }}>
                  <div style={{ width: 32, height: 32, borderRadius: "50%", background: bg, display: "flex", alignItems: "center", justifyContent: "center", fontSize: "14px", transition: "all 0.3s" }}>{completed ? "âœ“" : s.icon}</div>
                  <span style={{ fontSize: "10px", fontWeight: 600, color: tc, textTransform: "uppercase", letterSpacing: "0.3px", textAlign: "center" }}>{s.l}</span>
                </div>
                {i < 5 && <div style={{ flex: 1, height: "2px", background: completed ? "#22C55E" : active ? "#38BDF8" : "#334155", margin: "0 4px", marginBottom: "18px", transition: "background 0.5s" }} />}
              </React.Fragment>
            );
          })}
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PIPELINE SIMULATOR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function PipelineSimulator() {
      const [stage, setStage] = useState(0);
      const [autoPlay, setAutoPlay] = useState(false);
      const [expandedKpi, setExpandedKpi] = useState(null);

      useEffect(() => {
        if (!autoPlay || stage >= 6) return;
        const timer = setTimeout(() => setStage(s => s + 1), 2200);
        return () => clearTimeout(timer);
      }, [stage, autoPlay]);

      const reset = () => { setStage(0); setAutoPlay(false); };
      const runAll = () => { setStage(1); setAutoPlay(true); };
      const stepNext = () => { if (stage < 6) setStage(s => s + 1); };

      return (
        <div>
          <StageBar stage={stage} />
          <div style={{ display: "flex", gap: "12px", marginBottom: "24px", justifyContent: "center" }}>
            <button onClick={runAll} disabled={autoPlay && stage < 6} style={{ padding: "10px 24px", background: "#2563EB", color: "#fff", border: "none", borderRadius: "8px", fontWeight: 600, cursor: "pointer", fontSize: "13px", opacity: autoPlay && stage < 6 ? 0.6 : 1 }}>â–¶ Run Full Pipeline</button>
            <button onClick={stepNext} disabled={stage >= 6} style={{ padding: "10px 24px", background: "#1E293B", color: "#CBD5E1", border: "1px solid #475569", borderRadius: "8px", fontWeight: 600, cursor: "pointer", fontSize: "13px", opacity: stage >= 6 ? 0.4 : 1 }}>Step â†’</button>
            <button onClick={reset} style={{ padding: "10px 24px", background: "#1E293B", color: "#CBD5E1", border: "1px solid #475569", borderRadius: "8px", fontWeight: 600, cursor: "pointer", fontSize: "13px" }}>â†» Reset</button>
          </div>

          {stage === 0 && (
            <div className="fade-in" style={{ textAlign: "center", padding: "80px 20px", color: "#64748B" }}>
              <div style={{ fontSize: "48px", marginBottom: "16px" }}>ğŸ”„</div>
              <h3 style={{ fontSize: "18px", marginBottom: "8px", color: "#94A3B8" }}>Pipeline Ready</h3>
              <p>Shows how data flows from source systems through Flowable into the Risk Engine for scoring</p>
            </div>
          )}

          {/* Stage 1: Source Systems â€” SST + Bureau APIs */}
          {stage >= 1 && (
            <div className={`stage-card fade-in ${stage === 1 ? "active" : "completed"}`}>
              <div style={{ display: "flex", alignItems: "center", gap: "12px", marginBottom: "16px" }}>
                <span style={{ fontSize: "20px" }}>ğŸ¢</span>
                <div>
                  <h3 style={{ fontSize: "15px", fontWeight: 700, color: stage >= 2 ? "#22C55E" : "#38BDF8" }}>Stage 1: Source Systems</h3>
                  <p style={{ fontSize: "12px", color: "#64748B" }}>LeaseTeq SST (CRM + origination platform) and external bureau APIs provide all data</p>
                </div>
              </div>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "16px" }}>
                {/* SST */}
                <div style={{ background: "#0F172A", border: "1px solid #38BDF844", borderRadius: "10px", padding: "16px" }}>
                  <div style={{ display: "flex", alignItems: "center", gap: "8px", marginBottom: "12px" }}>
                    <span style={{ fontSize: "18px" }}>ğŸ¢</span>
                    <div>
                      <div style={{ fontSize: "14px", fontWeight: 700, color: "#38BDF8" }}>LeaseTeq SST</div>
                      <div style={{ fontSize: "10px", color: "#64748B" }}>Source CRM &amp; Origination Platform â€” 100% digital auto leasing</div>
                    </div>
                  </div>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "8px" }}>
                    {[
                      { group: "Person Data", fields: ["date_of_birth", "nationality", "foreigner_id_card", "marital_status"] },
                      { group: "Income &amp; Expenses", fields: ["net_income", "regular_expenses", "existing_contract_costs", "alimony_costs"] },
                      { group: "Contract Data", fields: ["financed_amount", "offer_price", "duration", "monthly_payment", "dscr_value"] },
                      { group: "Vehicle &amp; Dealer", fields: ["brand, model, is_electric", "dealer_id, dealer_name"] },
                    ].map((g, i) => (
                      <div key={i} style={{ background: "#1E293B", borderRadius: "6px", padding: "8px" }}>
                        <div style={{ fontSize: "9px", fontWeight: 700, color: "#38BDF8", textTransform: "uppercase", letterSpacing: "0.5px", marginBottom: "4px" }} dangerouslySetInnerHTML={{__html: g.group}} />
                        {g.fields.map((f, j) => <div key={j} style={{ fontSize: "10px", color: "#94A3B8", fontFamily: "monospace", padding: "1px 0" }}>{f}</div>)}
                      </div>
                    ))}
                  </div>
                  <div className="note-box" style={{ marginTop: "10px" }}>
                    <strong style={{ color: "#F59E0B" }}>Note:</strong> DSCR is now calculated at source by SST â€” used by underwriters during lease origination. Previously calculated in DWH.
                  </div>
                </div>

                {/* External Bureau APIs */}
                <div style={{ display: "flex", flexDirection: "column", gap: "10px" }}>
                  {[
                    { name: "CRIF Bureau API", icon: "ğŸ“Š", color: "#A78BFA", desc: "Swiss credit score (0-1000)", fields: ["crif_score", "credit_rating", "country_code"] },
                    { name: "ZEK Bureau API", icon: "ğŸ”", color: "#FB923C", desc: "Central credit information (Zentralstelle fÃ¼r Kreditinformation)", fields: ["zek_code", "zek_entry_count", "zek_has_entries"] },
                    { name: "Intrum API", icon: "ğŸ“‹", color: "#34D399", desc: "Debt collection &amp; recovery data", fields: ["intrum_score", "collection_procedures"] },
                    { name: "Zefix API", icon: "ğŸ›ï¸", color: "#64748B", desc: "Swiss commercial register â€” B2B company verification", fields: ["company_data", "legal_form", "registration_status"] },
                  ].map((api, i) => (
                    <div key={i} style={{ background: "#0F172A", border: `1px solid ${api.color}44`, borderRadius: "8px", padding: "10px", display: "flex", alignItems: "center", gap: "10px" }}>
                      <span style={{ fontSize: "20px" }}>{api.icon}</span>
                      <div style={{ flex: 1 }}>
                        <div style={{ fontSize: "12px", fontWeight: 700, color: api.color }}>{api.name}</div>
                        <div style={{ fontSize: "9px", color: "#64748B" }} dangerouslySetInnerHTML={{__html: api.desc}} />
                      </div>
                      <div style={{ display: "flex", gap: "4px", flexWrap: "wrap" }}>
                        {api.fields.map((f, j) => <span key={j} className="data-pill" style={{ background: `${api.color}15`, color: api.color, border: `1px solid ${api.color}33`, fontSize: "9px" }}>{f}</span>)}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* Stage 2: Flowable aggregates and POST */}
          {stage >= 2 && (
            <div className={`stage-card fade-in ${stage === 2 ? "active" : "completed"}`}>
              <div style={{ display: "flex", alignItems: "center", gap: "12px", marginBottom: "16px" }}>
                <span style={{ fontSize: "20px" }}>âš™ï¸</span>
                <div>
                  <h3 style={{ fontSize: "15px", fontWeight: 700, color: stage >= 3 ? "#22C55E" : "#38BDF8" }}>Stage 2: Flowable Reads Sources &amp; Sends POST</h3>
                  <p style={{ fontSize: "12px", color: "#64748B" }}>Flowable BPMN orchestrates: reads SST data + calls bureau APIs â†’ aggregates into a single JSON â†’ POST /v1/risk/evaluate</p>
                </div>
                <div style={{ marginLeft: "auto", padding: "4px 12px", background: "#1E3A5F", borderRadius: "6px", fontSize: "11px", color: "#38BDF8", fontWeight: 600, fontFamily: "monospace" }}>INPUT JSON</div>
              </div>
              <div style={{ display: "grid", gridTemplateColumns: "auto 1fr", gap: "16px" }}>
                <div style={{ display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", gap: "4px", padding: "0 8px" }}>
                  {["SST â†’","CRIF â†’","ZEK â†’","Intrum â†’"].map((s, i) => (
                    <div key={i} style={{ fontSize: "10px", color: "#38BDF8", fontFamily: "monospace", padding: "8px 0" }}>{s}</div>
                  ))}
                </div>
                <JsonHighlight data={SAMPLE_INPUT} />
              </div>
              <div className="note-box">
                <strong style={{ color: "#F59E0B" }}>Key:</strong> Risk Engine is <strong>stateless</strong> â€” it never reads from ODS/DWH. Everything arrives in this single POST. ODS/DWH is downstream (analytics &amp; reporting only).
              </div>
            </div>
          )}

          {/* Stage 3: KPI Derivation */}
          {stage >= 3 && (
            <div className={`stage-card fade-in ${stage === 3 ? "active" : "completed"}`}>
              <div style={{ display: "flex", alignItems: "center", gap: "12px", marginBottom: "16px" }}>
                <span style={{ fontSize: "20px" }}>ğŸ”¬</span>
                <div>
                  <h3 style={{ fontSize: "15px", fontWeight: 700, color: stage >= 4 ? "#22C55E" : "#38BDF8" }}>Stage 3: KPI Derivation</h3>
                  <p style={{ fontSize: "12px", color: "#64748B" }}>Raw inputs transformed into 10 standardized risk KPIs â€” some DIRECT from source, others CALCULATED by engine</p>
                </div>
              </div>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 40px 1fr 40px 1fr", padding: "8px 0", borderBottom: "2px solid #334155", marginBottom: "4px" }}>
                <div style={{ fontSize: "10px", fontWeight: 700, color: "#64748B", textTransform: "uppercase", letterSpacing: "0.5px" }}>Source System &amp; Fields</div>
                <div></div>
                <div style={{ fontSize: "10px", fontWeight: 700, color: "#64748B", textTransform: "uppercase", letterSpacing: "0.5px" }}>Derivation</div>
                <div></div>
                <div style={{ fontSize: "10px", fontWeight: 700, color: "#64748B", textTransform: "uppercase", letterSpacing: "0.5px" }}>Risk KPI</div>
              </div>
              {SOURCE_MAPPING.map((m, i) => (
                <div key={i} className="mapping-row" onClick={() => setExpandedKpi(expandedKpi === m.kpi ? null : m.kpi)} style={{ cursor: "pointer", background: expandedKpi === m.kpi ? "#0F172A" : "transparent", borderRadius: "4px", padding: "10px 8px" }}>
                  <div className="src-col">
                    <div style={{ fontSize: "10px", color: "#64748B" }}>{m.sources.join(" + ")}</div>
                    {m.sourceFields.map((f, j) => <div key={j} style={{ color: "#A78BFA" }}>{f}</div>)}
                  </div>
                  <div className="arrow-col">â†’</div>
                  <div className="formula-col">
                    {m.formula}
                    {expandedKpi === m.kpi && <div style={{ marginTop: "4px", color: "#94A3B8", fontSize: "10px", fontFamily: "sans-serif" }}>{m.description}</div>}
                  </div>
                  <div className="arrow-col">â†’</div>
                  <div className="kpi-col" style={{ display: "flex", alignItems: "center", gap: "8px" }}>
                    <span>{m.kpi}</span>
                    <span className="data-pill" style={{ background: m.type === "CALCULATED" ? "#7C3AED22" : "#0F766E22", color: m.type === "CALCULATED" ? "#A78BFA" : "#2DD4BF", border: `1px solid ${m.type === "CALCULATED" ? "#A78BFA33" : "#2DD4BF33"}` }}>{m.type}</span>
                  </div>
                </div>
              ))}
              <p style={{ fontSize: "10px", color: "#475569", marginTop: "8px", textAlign: "center" }}>Click any row for details Â· <span style={{ color: "#A78BFA" }}>CALCULATED</span> = derived by engine Â· <span style={{ color: "#2DD4BF" }}>DIRECT</span> = from source system</p>
            </div>
          )}

          {/* Stage 4: Bin Lookup + Scoring */}
          {stage >= 4 && (
            <div className={`stage-card fade-in ${stage === 4 ? "active" : "completed"}`}>
              <div style={{ display: "flex", alignItems: "center", gap: "12px", marginBottom: "16px" }}>
                <span style={{ fontSize: "20px" }}>ğŸ“Š</span>
                <div>
                  <h3 style={{ fontSize: "15px", fontWeight: 700, color: stage >= 5 ? "#22C55E" : "#38BDF8" }}>Stage 4: Scorecard Bin Lookup</h3>
                  <p style={{ fontSize: "12px", color: "#64748B" }}>Each KPI value matched to a calibrated bin â†’ raw score assigned</p>
                </div>
              </div>
              <table style={{ width: "100%", fontSize: "12px", borderCollapse: "collapse" }}>
                <thead>
                  <tr style={{ textAlign: "left", color: "#64748B", fontSize: "10px", textTransform: "uppercase" }}>
                    <th style={{ padding: "8px" }}>KPI</th><th style={{ padding: "8px" }}>Weight</th><th style={{ padding: "8px" }}>Value</th><th style={{ padding: "8px" }}>â†’ Bin</th><th style={{ padding: "8px" }}>Score</th><th style={{ padding: "8px", width: "180px" }}></th>
                  </tr>
                </thead>
                <tbody>
                  {SAMPLE_OUTPUT.factor_scores.map((f, i) => {
                    const barW = Math.abs(f.raw_score) / 10 * 100;
                    const barC = f.raw_score > 0 ? "#22C55E" : f.raw_score < 0 ? "#EF4444" : "#64748B";
                    return (
                      <tr key={i} style={{ borderTop: "1px solid #1E293B", animation: `slideRight 0.3s ease ${i * 0.04}s both` }}>
                        <td style={{ padding: "8px", fontWeight: 600 }}>{f.factor_name}</td>
                        <td style={{ padding: "8px", fontFamily: "monospace", color: "#64748B" }}>{(f.weight * 100)}%</td>
                        <td style={{ padding: "8px", fontFamily: "monospace", color: "#38BDF8" }}>{f.raw_value}</td>
                        <td style={{ padding: "8px" }}><span className="data-pill" style={{ background: "#1E293B", color: "#A78BFA", border: "1px solid #334155" }}>{f.bin_label}</span></td>
                        <td style={{ padding: "8px", fontFamily: "monospace", fontWeight: 700, color: barC, fontSize: "14px" }}>{f.raw_score > 0 ? "+" : ""}{f.raw_score}</td>
                        <td style={{ padding: "8px" }}><div style={{ height: "6px", background: "#1E293B", borderRadius: "3px", overflow: "hidden" }}><div className="kpi-bar" style={{ width: `${barW}%`, background: barC }} /></div></td>
                      </tr>
                    );
                  })}
                  <tr style={{ borderTop: "2px solid #475569" }}>
                    <td colSpan="4" style={{ padding: "12px 8px", fontWeight: 700, fontSize: "14px" }}>Total Composite Score</td>
                    <td style={{ padding: "12px 8px", fontFamily: "monospace", fontWeight: 700, fontSize: "20px", color: "#22C55E" }}>+{SAMPLE_OUTPUT.total_score}</td>
                    <td></td>
                  </tr>
                </tbody>
              </table>
            </div>
          )}

          {/* Stage 5: Business Rules + Tier */}
          {stage >= 5 && (
            <div className={`stage-card fade-in ${stage === 5 ? "active" : "completed"}`}>
              <div style={{ display: "flex", alignItems: "center", gap: "12px", marginBottom: "16px" }}>
                <span style={{ fontSize: "20px" }}>âš–ï¸</span>
                <div>
                  <h3 style={{ fontSize: "15px", fontWeight: 700, color: stage >= 6 ? "#22C55E" : "#38BDF8" }}>Stage 5: Business Rules &amp; Tier Assignment</h3>
                  <p style={{ fontSize: "12px", color: "#64748B" }}>8 hard-kill rules checked â†’ score mapped to tier â†’ decision</p>
                </div>
              </div>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "16px" }}>
                <div style={{ background: "#0F172A", borderRadius: "8px", padding: "16px", border: "1px solid #22C55E44" }}>
                  <h4 style={{ fontSize: "12px", color: "#22C55E", fontWeight: 700, marginBottom: "10px" }}>âœ“ Business Rules â€” All Clear</h4>
                  {["BR-01: age â‰¥ 18 âœ“","BR-02: LTV â‰¤ 120% âœ“","BR-03: DSCR â‰¥ 0 âœ“","BR-04: ZEK entries < 3 âœ“","BR-05: CRIF â‰¥ 150 âœ“","BR-06: Income present âœ“","BR-07: Dealer DR â‰¤ 20% âœ“","BR-08: Term â‰¤ 72m âœ“"].map((r,i) => (
                    <div key={i} style={{ fontSize: "11px", color: "#94A3B8", padding: "3px 0", fontFamily: "monospace" }}>{r}</div>
                  ))}
                </div>
                <div style={{ display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", background: "#0F172A", borderRadius: "8px", padding: "24px", border: "2px solid #27AE60" }}>
                  <div style={{ fontSize: "10px", color: "#64748B", textTransform: "uppercase", letterSpacing: "1px", marginBottom: "8px" }}>Tier Result</div>
                  <div style={{ width: "72px", height: "72px", borderRadius: "50%", background: "#27AE60", display: "flex", alignItems: "center", justifyContent: "center", boxShadow: "0 0 30px #27AE6044" }}>
                    <span style={{ fontSize: "22px", fontWeight: 700 }}>31</span>
                  </div>
                  <div style={{ fontSize: "16px", fontWeight: 700, color: "#27AE60", marginTop: "8px" }}>BRIGHT_GREEN</div>
                  <div style={{ fontSize: "13px", color: "#E2E8F0", marginTop: "2px" }}>AUTO_APPROVE</div>
                  <div style={{ fontSize: "11px", color: "#64748B", marginTop: "2px" }}>PD: 1.5%</div>
                  <div style={{ display: "flex", gap: "4px", marginTop: "12px", width: "100%" }}>
                    {[{ n:"RED",c:"#E74C3C",s:"< 0" },{ n:"YELLOW",c:"#F39C12",s:"â‰¥ 0" },{ n:"GREEN",c:"#2ECC71",s:"â‰¥ 10" },{ n:"B.GREEN",c:"#27AE60",s:"â‰¥ 25" }].map((t,i) => (
                      <div key={i} style={{ flex:1, textAlign:"center", padding:"5px 2px", borderRadius:"4px", background: i===3 ? t.c : t.c+"33" }}>
                        <div style={{ fontSize:"8px", fontWeight:700, color:"#fff" }}>{t.n}</div>
                        <div style={{ fontSize:"7px", color:"rgba(255,255,255,0.7)" }}>{t.s}</div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Stage 6: Response JSON */}
          {stage >= 6 && (
            <div className={`stage-card fade-in completed`}>
              <div style={{ display: "flex", alignItems: "center", gap: "12px", marginBottom: "16px" }}>
                <span style={{ fontSize: "20px" }}>ğŸ“¥</span>
                <div>
                  <h3 style={{ fontSize: "15px", fontWeight: 700, color: "#22C55E" }}>Stage 6: JSON Response â†’ Flowable</h3>
                  <p style={{ fontSize: "12px", color: "#64748B" }}>Synchronous response â€” Flowable routes to next BPMN step based on decision</p>
                </div>
                <div style={{ marginLeft: "auto", padding: "4px 12px", background: "#1F3B2E", borderRadius: "6px", fontSize: "11px", color: "#22C55E", fontWeight: 600, fontFamily: "monospace" }}>OUTPUT JSON Â· ~3ms</div>
              </div>
              <JsonHighlight data={SAMPLE_OUTPUT} />
            </div>
          )}
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INPUT / OUTPUT SIDE-BY-SIDE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function InputOutputView() {
      return (
        <div className="fade-in">
          <p style={{ textAlign: "center", color: "#64748B", fontSize: "13px", marginBottom: "20px" }}>Exact JSON payloads exchanged between Flowable and Risk Engine</p>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 60px 1fr", gap: "0", alignItems: "start" }}>
            <div>
              <div style={{ display: "flex", alignItems: "center", gap: "8px", marginBottom: "12px" }}>
                <div style={{ padding: "4px 12px", background: "#1E3A5F", borderRadius: "6px", fontSize: "12px", color: "#38BDF8", fontWeight: 700, fontFamily: "monospace" }}>POST /v1/risk/evaluate</div>
                <span style={{ fontSize: "12px", color: "#64748B" }}>From Flowable (SST + Bureaus)</span>
              </div>
              <JsonHighlight data={SAMPLE_INPUT} />
            </div>
            <div style={{ display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", paddingTop: "200px" }}>
              <div style={{ fontSize: "24px", color: "#38BDF8" }}>â†’</div>
              <div style={{ fontSize: "10px", color: "#64748B", textAlign: "center", marginTop: "4px" }}>Risk<br/>Engine<br/>v1.2</div>
              <div style={{ fontSize: "24px", color: "#22C55E", marginTop: "4px" }}>â†’</div>
            </div>
            <div>
              <div style={{ display: "flex", alignItems: "center", gap: "8px", marginBottom: "12px" }}>
                <div style={{ padding: "4px 12px", background: "#1F3B2E", borderRadius: "6px", fontSize: "12px", color: "#22C55E", fontWeight: 700, fontFamily: "monospace" }}>200 OK</div>
                <span style={{ fontSize: "12px", color: "#64748B" }}>Back to Flowable</span>
              </div>
              <JsonHighlight data={SAMPLE_OUTPUT} />
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ARCHITECTURE DIAGRAM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function ArchitectureDiagram() {
      return (
        <div className="fade-in">
          <div style={{ textAlign: "center", marginBottom: "12px" }}>
            <span style={{ fontSize: "11px", color: "#64748B", textTransform: "uppercase", letterSpacing: "1px", fontWeight: 600 }}>Source Systems</span>
          </div>
          <div style={{ display: "grid", gridTemplateColumns: "2fr 1fr 1fr 1fr", gap: "12px", marginBottom: "8px" }}>
            <div className="arch-box" style={{ borderColor: "#38BDF866", background: "#1E293B" }}>
              <div style={{ fontSize: "24px", marginBottom: "6px" }}>ğŸ¢</div>
              <div style={{ fontSize: "14px", fontWeight: 700, color: "#38BDF8" }}>LeaseTeq SST</div>
              <div style={{ fontSize: "10px", color: "#64748B" }}>Source CRM + Origination Platform</div>
              <div style={{ fontSize: "9px", color: "#475569", marginTop: "4px", fontFamily: "monospace" }}>persons, contracts, incomes, expenses, vehicles, dealers, DSCR</div>
            </div>
            {[
              { name: "CRIF API", color: "#A78BFA", icon: "ğŸ“Š", desc: "Credit score" },
              { name: "ZEK / Intrum", color: "#FB923C", icon: "ğŸ”", desc: "Credit info + collections" },
              { name: "Zefix API", color: "#64748B", icon: "ğŸ›ï¸", desc: "B2B company register" },
            ].map((s, i) => (
              <div key={i} className="arch-box" style={{ borderColor: s.color + "66", background: "#1E293B" }}>
                <div style={{ fontSize: "20px", marginBottom: "4px" }}>{s.icon}</div>
                <div style={{ fontSize: "12px", fontWeight: 700, color: s.color }}>{s.name}</div>
                <div style={{ fontSize: "9px", color: "#64748B", marginTop: "2px" }}>{s.desc}</div>
              </div>
            ))}
          </div>

          <div style={{ textAlign: "center", padding: "4px 0" }}>
            <div style={{ display: "inline-flex", flexDirection: "column", alignItems: "center" }}>
              <div style={{ width: "2px", height: "12px", background: "linear-gradient(180deg, #334155, #38BDF8)" }} />
              <div style={{ fontSize: "10px", padding: "3px 10px", background: "#1E3A5F", color: "#38BDF8", borderRadius: "4px", fontWeight: 600 }}>Flowable reads from SST + calls bureau APIs</div>
              <div style={{ fontSize: "14px", color: "#38BDF8" }}>â–¼</div>
            </div>
          </div>

          <div className="arch-box" style={{ borderColor: "#38BDF8", background: "#0F172A", margin: "0 auto", maxWidth: "700px", marginBottom: "8px" }}>
            <div style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: "12px" }}>
              <span style={{ fontSize: "22px" }}>âš™ï¸</span>
              <div>
                <div style={{ fontSize: "16px", fontWeight: 700, color: "#38BDF8" }}>Flowable BPMN Engine</div>
                <div style={{ fontSize: "10px", color: "#64748B" }}>Orchestrates loan approval workflow â€” aggregates all data â†’ synchronous POST to Risk Engine</div>
              </div>
            </div>
            <div style={{ display: "flex", justifyContent: "center", gap: "4px", marginTop: "8px", flexWrap: "wrap" }}>
              {["Application", "Data Enrichment", "Risk Evaluation", "Decision Routing", "Notification"].map((step, i) => (
                <div key={i} style={{ padding: "3px 8px", background: i === 2 ? "#1E3A5F" : "#1E293B", border: `1px solid ${i === 2 ? "#38BDF8" : "#334155"}`, borderRadius: "4px", fontSize: "9px", color: i === 2 ? "#38BDF8" : "#64748B", fontWeight: 600 }}>{step}</div>
              ))}
            </div>
          </div>

          <div style={{ textAlign: "center", padding: "2px 0" }}>
            <div style={{ display: "inline-flex", alignItems: "center", gap: "24px" }}>
              <span style={{ fontSize: "9px", color: "#38BDF8", fontFamily: "monospace" }}>POST /v1/risk/evaluate â–¼</span>
              <span style={{ fontSize: "9px", color: "#22C55E", fontFamily: "monospace" }}>â–² JSON Response (tier, decision, scores, PD)</span>
            </div>
          </div>

          <div className="arch-box" style={{ borderColor: "#F59E0B", background: "#1E293B", marginBottom: "8px", padding: "20px" }}>
            <div style={{ textAlign: "center", marginBottom: "12px" }}>
              <div style={{ fontSize: "16px", fontWeight: 700, color: "#F59E0B" }}>ğŸ›¡ï¸ LT Risk Engine v1.2</div>
              <div style={{ fontSize: "10px", color: "#64748B" }}>Stateless microservice â€” FastAPI Â· Does NOT read from ODS/DWH</div>
            </div>
            <div style={{ display: "grid", gridTemplateColumns: "repeat(5, 1fr)", gap: "6px" }}>
              {[
                { name: "KPI Derivation", desc: "LTV, Age, DealerRisk calculated; rest direct", color: "#EF4444" },
                { name: "10-Factor Scorer", desc: "Calibrated bin lookup", color: "#F59E0B" },
                { name: "Composite Score", desc: "Weighted sum", color: "#22C55E" },
                { name: "Business Rules", desc: "8 hard-kill checks", color: "#A78BFA" },
                { name: "Tier + Decision", desc: "Score â†’ tier â†’ PD", color: "#38BDF8" },
              ].map((c, i) => (
                <div key={i} style={{ background: "#0F172A", borderRadius: "6px", padding: "8px", border: `1px solid ${c.color}33`, textAlign: "center" }}>
                  <div style={{ fontSize: "10px", fontWeight: 700, color: c.color }}>{c.name}</div>
                  <div style={{ fontSize: "8px", color: "#64748B", marginTop: "2px" }}>{c.desc}</div>
                </div>
              ))}
            </div>
          </div>

          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "16px", marginTop: "8px" }}>
            {/* Decision Outcomes */}
            <div>
              <div style={{ textAlign: "center", marginBottom: "8px" }}>
                <span style={{ fontSize: "10px", color: "#64748B", textTransform: "uppercase", fontWeight: 600 }}>Decision Outcomes (via Flowable)</span>
              </div>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "8px" }}>
                {[
                  { tier: "BRIGHT GREEN", decision: "Auto-Approve", color: "#27AE60", icon: "âœ…" },
                  { tier: "GREEN", decision: "Standard Approval", color: "#2ECC71", icon: "ğŸ‘" },
                  { tier: "YELLOW", decision: "Manual Review", color: "#F39C12", icon: "ğŸ‘¤" },
                  { tier: "RED", decision: "Decline", color: "#E74C3C", icon: "âŒ" },
                ].map((o, i) => (
                  <div key={i} className="arch-box" style={{ borderColor: o.color + "66", background: "#1E293B", padding: "10px" }}>
                    <span style={{ fontSize: "16px" }}>{o.icon}</span>
                    <div style={{ fontSize: "11px", fontWeight: 700, color: o.color, marginTop: "4px" }}>{o.tier}</div>
                    <div style={{ fontSize: "10px", color: "#E2E8F0" }}>{o.decision}</div>
                  </div>
                ))}
              </div>
            </div>

            {/* Downstream: ODS/DWH */}
            <div>
              <div style={{ textAlign: "center", marginBottom: "8px" }}>
                <span style={{ fontSize: "10px", color: "#64748B", textTransform: "uppercase", fontWeight: 600 }}>Downstream (Analytics &amp; Reporting)</span>
              </div>
              <div className="arch-box" style={{ borderColor: "#475569", background: "#0F172A", textAlign: "left" }}>
                <div style={{ display: "flex", alignItems: "center", gap: "8px", marginBottom: "8px" }}>
                  <span style={{ fontSize: "18px" }}>ğŸ—„ï¸</span>
                  <div>
                    <div style={{ fontSize: "13px", fontWeight: 700, color: "#94A3B8" }}>ODS / DWH (Data Hub)</div>
                    <div style={{ fontSize: "10px", color: "#475569" }}>Enterprise Data Warehouse â€” NOT in scoring path</div>
                  </div>
                </div>
                <div style={{ display: "flex", gap: "6px", flexWrap: "wrap" }}>
                  {["SST mirror tables", "Risk assessments", "Portfolio analytics", "Backtest data", "Reporting", "Model monitoring"].map((t, i) => (
                    <span key={i} className="data-pill" style={{ background: "#1E293B", color: "#64748B", border: "1px solid #33415544", fontSize: "9px" }}>{t}</span>
                  ))}
                </div>
                <div style={{ marginTop: "8px", fontSize: "9px", color: "#475569", fontStyle: "italic" }}>
                  â† SST data replicated here for analytics. Risk assessment results also stored here after scoring.
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MAIN APP
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function App() {
      const [view, setView] = useState("pipeline");
      return (
        <div style={{ minHeight: "100vh" }}>
          <div style={{ background: "#1E293B", borderBottom: "1px solid #334155" }}>
            <div style={{ maxWidth: "1200px", margin: "0 auto", padding: "14px 24px" }}>
              <h1 style={{ fontSize: "20px", fontWeight: 700 }}>LT Risk Engine â€” Data Flow &amp; Architecture</h1>
              <p style={{ fontSize: "12px", color: "#64748B", marginTop: "3px" }}>Model <span style={{ fontFamily: "monospace", color: "#38BDF8" }}>v1.2.0</span> Â· Aralytiks LLC</p>
            </div>
          </div>
          <div style={{ maxWidth: "1200px", margin: "0 auto", padding: "0 24px", borderBottom: "1px solid #334155" }}>
            {[
              { key: "pipeline", label: "â–¶ Pipeline Simulator" },
              { key: "io", label: "{ } Input / Output JSON" },
              { key: "architecture", label: "ğŸ— Architecture Diagram" },
            ].map(t => (
              <button key={t.key} className={`tab-btn ${view === t.key ? "active" : ""}`} onClick={() => setView(t.key)}>{t.label}</button>
            ))}
          </div>
          <div style={{ maxWidth: "1200px", margin: "0 auto", padding: "24px" }}>
            {view === "pipeline" && <PipelineSimulator />}
            {view === "io" && <InputOutputView />}
            {view === "architecture" && <ArchitectureDiagram />}
          </div>
          <div style={{ textAlign: "center", padding: "20px", color: "#475569", fontSize: "11px" }}>LT Risk Engine v1.2.0 â€” Flow Visualization â€” Aralytiks LLC</div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
